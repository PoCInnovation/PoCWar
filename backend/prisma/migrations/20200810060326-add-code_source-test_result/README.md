# Migration `20200810060326-add-code_source-test_result`

This migration has been generated by Th√©o at 8/10/2020, 8:03:26 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "Lang" AS ENUM ('C', 'CPP', 'Go', 'Javascript', 'Python', 'Rust', 'Ruby');

CREATE TABLE "public"."TestResult" (
"id" SERIAL,
"codeSourceId" integer  NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."CodeSource" (
"id" SERIAL,
"lang" "Lang" NOT NULL ,
"code" text  NOT NULL ,
"challengeId" integer  NOT NULL ,
"authorId" integer  NOT NULL ,
"testResultId" integer   ,
PRIMARY KEY ("id"))

ALTER TABLE "public"."User" ADD COLUMN "password" text  NOT NULL ;

ALTER TABLE "public"."TestResult" ADD FOREIGN KEY ("codeSourceId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CodeSource" ADD FOREIGN KEY ("challengeId")REFERENCES "public"."Challenge"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CodeSource" ADD FOREIGN KEY ("authorId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CodeSource" ADD FOREIGN KEY ("testResultId")REFERENCES "public"."TestResult"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200809152954-init..20200810060326-add-code_source-test_result
--- datamodel.dml
+++ datamodel.dml
@@ -1,27 +1,40 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
 }
+enum Lang {
+  C
+  CPP
+  Go
+  Javascript
+  Python
+  Rust
+  Ruby
+}
+
 model User {
-    id         Int @default(autoincrement()) @id
-    name       String
-    email      String @unique
-    challenges Challenge[]
+  id          Int @default(autoincrement()) @id
+  name        String
+  email       String @unique
+  password    String
+  challenges  Challenge[]
+  codeSources CodeSource[]
 }
 model Challenge {
-  id       Int @default(autoincrement()) @id
-  name     String
-  slug     String @unique
-  tests    Test[]
-  author   User @relation(fields: [authorId], references: [id])
-  authorId Int
+  id          Int @default(autoincrement()) @id
+  name        String
+  slug        String @unique
+  tests       Test[]
+  codeSources CodeSource[]
+  author      User @relation(fields: [authorId], references: [id])
+  authorId    Int
 }
 model Test {
   id          Int @default(autoincrement()) @id
@@ -30,5 +43,22 @@
   err         String
   ret         Int
   challenge   Challenge @relation(fields: [challengeId], references: [id])
   challengeId Int
+}
+
+model TestResult {
+  id           Int @default(autoincrement()) @id
+  codeSource   User @relation(fields: [codeSourceId], references: [id])
+  codeSourceId Int
+}
+
+model CodeSource {
+  id           Int @default(autoincrement()) @id
+  lang         Lang
+  code         String
+  challenge    Challenge @relation(fields: [challengeId], references: [id])
+  challengeId  Int
+  author       User @relation(fields: [authorId], references: [id])
+  authorId     Int
+  lastResult   TestResult?
 }
```


